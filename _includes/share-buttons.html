<!-- _includes/zap-widget.html -->
<div class="max-w-sm mx-auto">
  <!-- à¸›à¸¸à¹ˆà¸¡à¸«à¸¥à¸±à¸ -->
  <button id="zap-toggle" onclick="toggleZapForm()" 
          class="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-semibold py-2 px-4 rounded">
    âš¡ à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™
  </button>

  <!-- à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡ Zap (à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸‹à¹ˆà¸­à¸™) -->
  <div id="zap-form" class="mt-4 border border-yellow-300 bg-yellow-50 p-4 rounded hidden break-words">
    <label for="zap-amount" class="block mb-1 text-sm text-gray-700">ğŸ’¸ à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ (sats):</label>
    <input id="zap-amount" type="number" min="1" step="1" value="{{ site.lightning.default_zap }}"
           class="w-full p-2 border rounded mb-3">

    <button onclick="fetchZapInvoice()"
            class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-semibold py-2 px-4 rounded">
      ğŸ”„ à¸ªà¸£à¹‰à¸²à¸‡ QR à¸ªà¸³à¸«à¸£à¸±à¸š Zap
    </button>

    <div id="zap-result" class="mt-4 hidden text-center">
      <p class="text-sm text-gray-600">ğŸ“± à¸ªà¹à¸à¸™ QR à¹€à¸à¸·à¹ˆà¸­à¸ªà¸™à¸±à¸šà¸ªà¸™à¸¸à¸™:</p>
      <canvas id="zap-qr" class="mx-auto my-2"></canvas>
      <p class="text-xs text-gray-400" id="zap-pr"></p>
    </div>
  </div>
</div>

<!-- QR Code CDN -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
  function toggleZapForm() {
    const form = document.getElementById('zap-form');
    form.classList.toggle('hidden');
  }

  async function fetchZapInvoice() {
    const sats = parseInt(document.getElementById('zap-amount').value);
    const resultEl = document.getElementById('zap-result');
    const qrCanvas = document.getElementById('zap-qr');
    const prEl = document.getElementById('zap-pr');

    if (isNaN(sats) || sats < 1) {
      alert("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸ˆà¸³à¸™à¸§à¸™ sats à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡");
      return;
    }

    const lnurl = "https://walletofsatoshi.com/.well-known/lnurlp/khunjibna";

    try {
      const lnurlRes = await fetch(lnurl);
      const lnData = await lnurlRes.json();
      const callback = lnData.callback;
      const amountMsat = sats * 1000;

      const invoiceRes = await fetch(`${callback}?amount=${amountMsat}`);
      const invoiceData = await invoiceRes.json();

      if (invoiceData.pr) {
        resultEl.classList.remove("hidden");
        QRCode.toCanvas(qrCanvas, invoiceData.pr);
        prEl.innerText = invoiceData.pr;
      } else {
        alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¸£à¹‰à¸²à¸‡ invoice à¹„à¸”à¹‰");
      }
    } catch (e) {
      console.error(e);
      alert("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡ QR: " + e.message);
    }
  }
</script>
